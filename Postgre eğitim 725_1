-- payten 725 1.gÃ¼n
-- Temel Yedekleme AraÃ§larÄ±
-- Yedekleme AraÃ§larÄ± â€“ Uygulama
-- Replikasyon Temelleri
-- Replikasyon â€“ Uygulama


-- https://www.postgresql.org/docs/16/backup.html

/*

Chapter 26. Backup and Restore
Table of Contents

26.1. SQL Dump
26.1.1. Restoring the Dump
26.1.2. Using pg_dumpall
26.1.3. Handling Large Databases
26.2. File System Level Backup
26.3. Continuous Archiving and Point-in-Time Recovery (PITR)
26.3.1. Setting Up WAL Archiving
26.3.2. Making a Base Backup
26.3.3. Making a Base Backup Using the Low Level API
26.3.4. Recovering Using a Continuous Archive Backup
26.3.5. Timelines
26.3.6. Tips and Examples
26.3.7. Caveats
As with everything that contains valuable data, PostgreSQL databases should be backed up regularly. While the procedure is essentially simple, it is important to have a clear understanding of the underlying techniques and assumptions.

There are three fundamentally different approaches to backing up PostgreSQL data:

SQL dump (sÃ¼rekiliÄŸi bulunmamakta)

File system level backup (anlÄ±k tÃ¼m cluster snapshot)

Continuous archiving (son alÄ±nan file snapshot yanÄ±nda transaction loglarÄ±n alÄ±nmasÄ± iÅŸlemi  )

Each has its own strengths and weaknesses; each is discussed in turn in the following sections.

--https://www.postgresql.org/docs/17/backup-dump.html
26.1. SQL Dump 
26.1.1. Restoring the Dump
26.1.2. Using pg_dumpall
26.1.3. Handling Large Databases

The idea behind this dump method is to generate a file with SQL commands that, when fed back to the server, will recreate the database in the same state as it was at the time of the dump. PostgreSQL provides the utility program pg_dump for this purpose. The basic usage of this command is:

Sql dump yÃ¶ntemi ile veritabanÄ±nÄ±n t anÄ±ndaki durumunun sql komutlarÄ± halinde bir dosyaya yazÄ±lmasÄ± iÅŸlemidir.  Bu dosya ile geri dÃ¶nÃ¼ÅŸ yapÄ±ldÄ±ÄŸÄ±nda t anÄ±ndaki durumuna dÃ¶nÃ¼ÅŸ saÄŸlanmÄ±ÅŸ olacaktÄ±r.

--https://www.postgresql.org/docs/current/reference-client.html 

pg_dump  db_name > dumpfile   --> sql file oluÅŸmuÅŸ oluyor.

pg_dump db_name kÄ±smÄ± standart output Ã¼retir sonrasÄ±nda yazdÄ±ÄŸÄ±mÄ±z â€œ>â€ iÅŸareteti ile bu Ã§Ä±ktÄ±larÄ± yakala  â€œdumpfileâ€  isminde bir dosyaya yaz demiÅŸ oluyoruz.

pg_dump iÅŸlemini baÅŸlatan veritabanÄ± kullanÄ±cÄ±sÄ±nÄ±n sql dump alacaÄŸÄ± objelerde okuma (select) ya da kullanma (usage) yetkisi olmasÄ± gerekiyor.


psql -d dbname -f dumpfile --> bir file komutlarÄ± oynamatsÄ±  ,restore edilmesi


--https://www.postgresql.org/docs/current/app-pgdump.html 

pg_dump [connection-option...] [option...] [dbname] 


pg_dump -h 10.10.10.114 -p 5432 -d profelis > sql_profelis


dbname
Specifies the name of the database to be dumped. If this is not specified, the environment variable PGDATABASE is used. If that is not set, the user name specified for the connection is used.

dbname belirtilmez ise default olarak postgres iÃ§indeki objelerin dump iÅŸlemi baÅŸlatÄ±lÄ±r.



-a
--data-only
Dump only the data, not the schema (data definitions). Table data, large objects, and sequence values are dumped.

Sadece verileri almak istediÄŸimizde. Ã–rneÄŸin tabloda bulunan sadece veriyi almak istediÄŸimiz durumda.


pg_dump -h 10.10.10.114 -p 5432 -d profelis -t Ã¼rÃ¼n_tablo -a > sql_profelis


-c
--clean
Output commands to DROP all the dumped database objects prior to outputting the commands for creating them. This option is useful when the restore is to overwrite an existing database. If any of the objects do not exist in the destination database, ignorable error messages will be reported during restore, unless --if-exists is also specified.

pg_dump ile restore edilen objeler veritabanÄ±nda var ise drop edilirler. -f format belirtilerek alÄ±nan dump tipinde bu aktif deÄŸildir.

-C
--create
Begin the output with a command to create the database itself and reconnect to the created database. (With a script of this form, it doesn't matter which database in the destination installation you connect to before running the script.) If --clean is also specified, the script drops and recreates the target database before reconnecting to it.


pg_dump ile restore edilen veritabanÄ± var ise drop edilir. -f format belirtierek alÄ±nan dump filelarda bu aktif deÄŸildir.


-f file
--file=file
Send output to the specified file. This parameter can be omitted for file based output formats, in which case the standard output is used. It must be given for the directory output format however, where it specifies the target directory instead of a file. In this case the directory is created by pg_dump and must not exist before.


-F parametresi ile pg_dump komutu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z kullanabiliyoruz. Hangi konuma Ã§Ä±ktÄ± alÄ±nacaÄŸÄ±nÄ± belirtmek iÃ§in.


-F format
--format=format
Selects the format of the output. format can be one of the following:

Ã‡Ä±ktÄ± FormatÄ±nÄ± deÄŸiÅŸtirmek istediÄŸimiz durumda  -F komutu ve Ã§Ä±ktÄ± formatÄ±nÄ± belirtiyoruz. 

Ã¶rn: pg_dump -Fd  


format belirtilerek alÄ±nan dump dosyalarÄ± restore iÅŸleminde "pg_restore" aracÄ± kullanÄ±lÄ±r. 

-j njobs
--jobs=njobs

paralel Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz. 

20 tane paralel Ã§alÄ±tÅŸÄ±rdÄ±m, burdaki 500gb !!!.

--schema=pattern

Belirli ÅŸemalarÄ±n iÃ§inde objeleri dump Ã§Ä±ktÄ±sÄ±nÄ± almak istediÄŸimizde.

pg_dump -h 10.10.10.114 -p 5432 -d profelis -n log_semasi  > sql_profelis


-N pattern
--exclude-schema=pattern

BazÄ± ÅŸemalarÄ±n dump Ã§Ä±ktÄ±sÄ±nda bulunmasÄ±nÄ± istemediÄŸimiz durumda.


pg_dump -h 10.10.10.114 -p 5432 -d profelis -N log_semasi  > sql_profelis


-O
--no-owner
Dump Ã§Ä±ktÄ±sÄ± oluÅŸurken objelerdeki kullanÄ±cÄ± yetkileri olmadan alÄ±nmasÄ±nÄ± saÄŸlamaktadÄ±r.


-s
--schema-only 

dump dosyasÄ±nda sadece ddl komutlarÄ±nÄ±n olmasÄ± isteniyor ise.


-t pattern
--table=pattern

dump dosyasÄ±nda bulunacak tablolarÄ± filtrelemek iÃ§in.

-T pattern
--exclude-table=pattern

dump dosyasÄ±nda olmamasÄ± istenen tablolarÄ± filtrelemek iÃ§in.

-Z level
-Z method[:detail]
--compress=level
--compress=method[:detail]

Fc , Fd ile alÄ±nan dump dosyasÄ±nÄ±n sÄ±kÄ±ÅŸtÄ±rma metodunu belirlemek iÃ§in.


--inserts
insert bloklarÄ± halinde olmasÄ± iÃ§in.


Son olarak;

BaÄŸlantÄ± yapÄ±lacak postgresql sunucusu iÃ§in connection string;

pg_dump -d dbname -h host -p port -U username  . . . dump parametreleri ÅŸeklinde.

export PGPASSPASSWORD = 123213;
pg_dump .. 
batch scripti haline getirmek isteniyor ise pg_dump komutu Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, baÄŸlantÄ± yapÄ±lan postgres serverÄ± ÅŸifre soracaktÄ±r. Åifrenin arkaplanda gÃ¶nderilmesi iÃ§in .pgpass file tanÄ±mÄ± yapÄ±lmalÄ±dÄ±r.

Yada ÅŸifreyi PGPASSWORD ÅŸeklinde pg_dump komutundan Ã¶nce belirtilebilir.

pg_dump kullanÄ±m Ã¶rneklerini bakacak olursak,



pg_dump kullanÄ±m Ã¶rneklerini bakacak olursak,

##########################

To dump a database called mydb into an SQL-script file:

$ pg_dump mydb > db.sql
To reload such a script into a (freshly created) database named newdb:

$ psql -d newdb -f db.sql


##########################

To dump a database into a custom-format archive file:

$ pg_dump -Fc mydb > db.dump
To dump a database into a directory-format archive:

$ pg_dump -Fd mydb -f dumpdir


To dump a database into a directory-format archive in parallel with 5 worker jobs:

$ pg_dump -Fd mydb -j 5 -f dumpdir
To reload an archive file into a (freshly created) database named newdb:


$ pg_restore -d newdb db.dump

To reload an archive file into the same database it was dumped from, discarding the current contents of that database:


To dump a single table named mytab:

$ pg_dump -t mytab mydb > db.sql


To dump all tables whose names start with emp in the detroit schema, except for the table named employee_log:

$ pg_dump -t 'detroit.emp*' -T detroit.employee_log mydb > db.sql


-- Ã‡alÄ±ÅŸma XXX 

1- root kullanÄ±cÄ±sÄ±nda

mkdir /pgdata/backups
chown postgres:postgres /pgdata/backups


2- dvdrental yedeÄŸi indirme

wget  https://www.postgresqltutorial.com/wp-content/uploads/2019/05/dvdrental.zip -P /pgdata/backups/

3-  postgres kullanÄ±cÄ±sÄ±na geÃ§iÅŸ yapÄ±lÄ±r.

su - postgres

4 - dvdrental veritabanÄ±nÄ±n zipten Ã§Ä±karÄ±lmasÄ±.

unzip /pgdata/backups/dvdrental.zip

zip ten Ã§Ä±kan dosyamÄ±z .tar uzantÄ±lÄ± olduÄŸu iÃ§in pg_restore komutu kullanÄ±lmasÄ± gerekiyor.


7- restore edilecek veritabanÄ± oluÅŸturur.

/usr/lib/postgresql/17/bin/psql -c "create database dvdrental";


8- pg_restore komutu ile dump dosyasÄ± restore edilir.

/usr/lib/postgresql/17/bin/pg_restore -d dvdrental  dvdrental.tar


Ã‡alÄ±ÅŸma XXX


1- Bir Ã¶nceki Ã§alÄ±ÅŸmada restore ettiÄŸimiz dvdrental dumpÄ±nÄ± alalÄ±m.

/usr/lib/postgresql/17/bin/pg_dump -d dvdrental > /pgdata/backups/dvdrental.sql 

2- restore adÄ±mÄ± 
/usr/lib/postgresql/17/bin/psql -d  dvdrental_donus -f dvdrental.sql 


Ã‡alÄ±ÅŸma XXX 

VeritabanÄ±mÄ±z Ã§ok bÃ¼yÃ¼k alacaÄŸÄ±mÄ±z dump iÅŸleminde sÄ±kÄ±ÅŸtÄ±rma iÅŸlemi ve paralel ÅŸekilde Ã§alÄ±ÅŸarak iÅŸlemi hÄ±zlÄ± yapmak  istiyoruz.

1. /usr/lib/postgresql/17/bin/pg_dump -d dvdrental -j 5 -Fd -f  /pgdata/backups/dvdrental_compress 

2.oluÅŸturduÄŸumuz dumpÄ± restore etmek istediÄŸimizde, j 5 paralel 5 process ile Ã§alÄ±ÅŸmasÄ± 

/usr/lib/postgresql/16/bin/pg_restore -d dvdrental -j 5 dvdrental_compress.tar


26.1.2. Using pg_dumpall

https://www.postgresql.org/docs/16/backup-dump.html#BACKUP-DUMP-ALL


pg_dump dumps only a single database at a time, and it does not dump information about roles or tablespaces (because those are cluster-wide rather than per-database). To support convenient dumping of the entire contents of a database cluster, the pg_dumpall program is provided. pg_dumpall backs up each database in a given cluster, and also preserves cluster-wide data such as role and tablespace definitions. The basic usage of this command

pg_dump ile sadece bir veritabanÄ±na ait dump iÅŸlemleri gerÃ§ekleÅŸtirebiliriz. Postgres clusterda bulunanan kullanÄ±cÄ± tanÄ±mlarÄ±nÄ± ve veritabanlarÄ±nÄ± tek komutla almak istediÄŸimizde, pg_dumpall kullanmamÄ±z gerekiyor. 

Basit kullanÄ±mÄ±:

pg_dumpall > dumpfile

geri postgres sunucusuna yÃ¼kleme iÃ§in:

psql -f dumpfile postgres

pg_dumpall paralel Ã§alÄ±ÅŸmama Ã¶zelliÄŸi bulunmamaktadÄ±r.

TÃ¼m kÃ¼menin iskeletini alÄ±nmak istendiÄŸinde kullanÄ±lmasÄ± yararlÄ±dÄ±r. Bu iskelet restore edilerek. pg_dump ile alÄ±nan veritabanlarÄ± tek tek restore edilebilir. pg_dump ile alÄ±nan dumplarda kullanÄ±cÄ± rolleri tanÄ±mlÄ± olmamasÄ±nda kaynaklÄ± hata oluÅŸmasÄ±nÄ±n Ã¶nÃ¼ne geÃ§ilmiÅŸ olur.


dump yÃ¶ntemi ile server taÅŸÄ±nmasÄ± planlanÄ±yor ise;

1- pg_dumpall  -g ile global objelerin dumpÄ±
2- pg_dump ile tek tek veritabanlarÄ±nÄ±n dumpÄ±
3- 1.adÄ±mda alÄ±nan pg_dumpall restore edilmesi.
4- 2.adÄ±mda alÄ±nan veritabanlarÄ±n restore edilmesi.

Ã‡alÄ±ÅŸma 

1- Postgres kÃ¼mesinin -g pg_dumpall iÅŸlemi gerÃ§ekleÅŸtirelim

/usr/lib/postgresql/17/bin/pg_dumpall -g -f /pgdata/backups/global.sql


/usr/lib/postgresql/16/bin/pg_dumpall -s -f /pgdata/backups/global.sql --> test ortamlarÄ±nÄ± (metadata)


NOT:

psql --set ON_ERROR_STOP=on dbname < dumpfile

Her iki durumdada eksik ÅŸekilde restore olmuÅŸ olacaktÄ±r.

ya hep ya hiÃ§ mantÄ±ÄŸÄ± ile Ã§alÄ±ÅŸmasÄ± iÃ§in yarÄ±da kalmasÄ± durumunda yada bir hata olduÄŸunda veritabanÄ±n iÅŸlem Ã¶ncesi duruma dÃ¶nmesi iÃ§in.

-1  -- single-transaction parametresi psql komutuna eklenebilir.

11:00 


















1- root kullanÄ±cÄ±sÄ±nda

mkdir /pgdata/backups
chown postgres:postgres /pgdata/backups

2- dvdrental yedeÄŸi indirme

wget  https://www.postgresqltutorial.com/wp-content/uploads/2019/05/dvdrental.zip -P /pgdata/backups/

3-  postgres kullanÄ±cÄ±sÄ±na geÃ§iÅŸ yapÄ±lÄ±r.

su - postgres

4 - dvdrental veritabanÄ±nÄ±n zipten Ã§Ä±karÄ±lmasÄ±.

unzip /pgdata/backups/dvdrental.zip

zip ten Ã§Ä±kan dosyamÄ±z .tar uzantÄ±lÄ± olduÄŸu iÃ§in pg_restore komutu kullanÄ±lmasÄ± gerekiyor.

5 -  pg_dump aracÄ±nÄ±n konumu kontrol edilir.

find / -iname pg_ctl 2> /dev/null

6 - restore yapacaÄŸÄ±m veritabanÄ± ile uyumlu pg_dump aracÄ± belirlenir

 /usr/lib/postgresql/16/bin/pg_restore --version

versiyon kontrolu restore edilecek veritabanÄ± ile uyumlu olduÄŸu gÃ¶zlemlenir.
pg_restore (PostgreSQL) 16.4 (Ubuntu 16.4-1.pgdg22.04+2)

7- restore edilecek veritabanÄ± oluÅŸturur.

/usr/lib/postgresql/16/bin/psql -c "create database dvdrental";

8- pg_restore komutu ile dump dosyasÄ± restore edilir.

/usr/lib/postgresql/16/bin/pg_restore -d dvdrental  dvdrental.tar

pg_dump,   -> pg_restore -Fd ile pg_dump iÅŸlemi gerÃ§ekleÅŸtiÄŸinde kullanÄ±lÄ±yor.   -a data only 
pg_dumpall -> kullanÄ±cÄ±lar , database_cluster iskeletini almak istediÄŸimizde.    -s kullanÄ±cÄ± ve ddl iskeleti

26.2. File System Level Backup

Postgresql serverÄ±na ait dosyalarÄ±n olduÄŸu dizinin t anÄ±ndaki durumun kopyalanmasÄ± ile gerÃ§ekleÅŸmektedir. (kopyalama)


VeritabanÄ± sÃ¼rekli veri akan ve deÄŸiÅŸen bir yapÄ± olduÄŸu iÃ§in her an dosyalarÄ±n yapÄ±larÄ± deÄŸiÅŸime aÃ§Ä±ktÄ±r.
bir t anÄ±na ait ÅŸekilde dosyalar taÅŸÄ±nmaz ise tutarsÄ±zlÄ±k gerÃ§ekleÅŸebilir ve sunucu pg_ctl start komutu ile baÅŸlamaz.


A) Postgresql Sunucu KapatÄ±lmasÄ± ile backup iÅŸlemi gerÃ§ekleÅŸtirmek.

1- Postgresql server durdurulmalÄ±
2- Data dizini tar formatÄ± ile sunucu Ã¼zerinde baÅŸka bir konuma alÄ±nabilir.
3- Postgresql server geri baÅŸlatÄ±lÄ±r.

tar -cf backup.tar  data_directory

B) Postgresql Sunucu KapatÄ±lmadan backup iÅŸlemi gerÃ§ekleÅŸtirmek.

BazÄ± filesystem lerde dosyalarÄ±n t anÄ±ndaki gÃ¶rÃ¼ntÃ¼sÃ¼ sabit tutacak ve paralelde verilerin deÄŸiÅŸmesine izin veren Ã¶zellik bulunmaktadÄ±r.

Bu tarz bir filesystem ,

1- Postgresql checkpoint iÅŸlemi baÅŸlatÄ±lÄ±r.
2- Filesystemde t anÄ±nda snapshot iÅŸlemi baÅŸlatÄ±lÄ±r.
3- bu snapshot anÄ±na ait dosyalar baÅŸka bir konuma taÅŸÄ±nÄ±r.
4- Filesystemde tutulan snapshot serbest bÄ±rakÄ±lÄ±r.

Ã¶rn. zfs  


C) Postgresql Sunucusunun minimum dÃ¼zeyde kapatÄ±lmasÄ± ile backup iÅŸlemini gerÃ§ekleÅŸtirmek.

1- Postgresql data dizini rsync ile kopyalanmasÄ± gerÃ§ekleÅŸtirilir.
2- Postgresql server kapatÄ±larak. rsync â€“checksum komutu ile sadece deÄŸiÅŸen dosyalar tekrardan kopyalanÄ±r.
3- Postgresql Server geri baÅŸlatÄ±lÄ±r. 


Ã‡ALIÅMA rsync

rsync -r /pgdata/pg16/ /pgdata/backups/rsync_backup

-- sunucu kapatÄ±larak , sadece deÄŸiÅŸiklik olanlarÄ± gÃ¼ncellenmesi
rsync -r /pgdata/pg16/ /pgdata/backups/rsync_backup --checksum

profelis dosyasÄ± yedek tarafÄ±nda gÃ¶rÃ¼lecektir.

--https://www.postgresql.org/docs/17/continuous-archiving.html

filesystem ->  pg_basebackup,  postgres tool  database_cluster yedeÄŸini almak istediÄŸimizde.


PostgreSQL, her zaman, kÃ¼menin veri dizinindeki pg_wal/ alt dizininde bir WAL (Write Ahead Log) kaydÄ± tutar.Bu wal dizininde, veritabanÄ±nÄ±n data bloklarÄ±nda yapÄ±lan her deÄŸiÅŸikliÄŸin log kaydÄ± tutulur. Bu wal dizinin Ã¶ncelikli amacÄ± crash anÄ±nda veri kaybÄ±nÄ±n Ã¶nÃ¼ne geÃ§mek iÃ§indir. Sistemde bir Ã§Ã¶kme yaÅŸarsa, PostgreSQL, son kontrol noktasÄ±ndan itibaren yapÄ±lan deÄŸiÅŸiklikleri  "yeniden oynatarak" (REDO log) Postgresql kapanma Ã¶ncesi duruma geri getirir.


Bu yÃ¶ntemin bize kazandÄ±rdÄ±ÄŸÄ± ikinci fayda ise, 

Bir kez aldÄ±ÄŸÄ±mÄ±z file-system-level backup Ã¼zerine, eksiksiz, ÅŸekilde pg_wal dizinindeki dosyalarÄ±n yedeÄŸinini alÄ±r isek.AldÄ±ÄŸÄ±mÄ±z file backup Ã¼zerine bu wal dosyalarÄ±nÄ± oynatarak sistemi mevcut durumuna getirebiliriz.

pazartesi fullbackup kopyaladÄ±m. 
salÄ±    wal dosyalar yedeÄŸi
Ã§arÅŸamba wal dosyalar yedeÄŸi
perÅŸembe  wal dosyalar yedeÄŸi


Bu yÃ¶ntem ile;

1)  MÃ¼kemmel ÅŸekilde t anÄ±nda kopyaladÄ±ÄŸÄ±mÄ±z bir data dizinine ihtiyacÄ±mÄ±z bulunmamaktadÄ±r. Data dizininde oluÅŸacak herhangi bir tutarsÄ±zlÄ±k pg_wal dizininde kayÄ±tlar sayesinde dÃ¼zeltilecektir.

2) Bu wal dosyalarÄ±nÄ±n sÃ¼rekli arÅŸivleyerek, SÄ±k sÄ±k full backup almanÄ±n uygun olmayacaÄŸÄ± bÃ¼yÃ¼k veri tabanlarÄ±nÄ±n olduÄŸu PostgreSQL serverlarÄ±n backuplarÄ±n tutulmasÄ±nda yÃ¶ntem olarak kullanabiliriz.

3) Wal dosyalarÄ±nÄ± belirli bir noktaya kadar oynatÄ±lmasÄ± saÄŸlanabilmektedir. Bu sayede alÄ±nan full backup Ã¼zerine wal dosyasÄ±nda bulunana deÄŸiÅŸiklikler istediÄŸimiz bir ana kadar oynatabiliriz. Bu teknik ile point-in-time recovery (PITR)  Ã¶zelliÄŸini saÄŸlanÄ±r.

4) ikinci bir sunucuya taÅŸÄ±yacaÄŸÄ±mÄ±z data dizinin Ã¼zerine aralÄ±ksÄ±z wal dosyalarÄ±nÄ±n taÅŸÄ±nmasÄ±nÄ± saÄŸlar isek, bu sunucuyu warm standby  olarak kullanabiliriz. Herhangi bir zamanda ikinci sunuyu aktif ederek NEREDEYSE gÃ¼ncel bir kopyasÄ±na sahip olabiliriz.

pg_dump ve pg_dumpall sonucu dÄ±ÅŸarÄ± sql komutlarÄ± oluÅŸmaktadÄ±r. Wal dosyalarÄ±nda ise deÄŸiÅŸime uÄŸrayan data page bloklarÄ±nÄ±n bilgisi bulunmaktadÄ±r. Bundan dolayÄ± dump Ã§Ä±ktÄ±larÄ±nda wal dosyalarÄ± replay edilemez.

VeritabanlarÄ± gibi sÃ¼rekli veri akÄ±ÅŸÄ±nÄ±n olduÄŸu yapÄ±larda, kurgulanan backup yÃ¶nteminde bu sÃ¼rekli deÄŸiÅŸen verilerin akÄ±ÅŸÄ±nÄ± kapsayacak yapÄ±da olmalÄ±. Kesik kesik alÄ±nan pg_dump / pg_dumpall Ã§Ä±ktÄ±lar bu noktada bunu saÄŸlamayacaktÄ±r. 


26.3.1. Setting Up WAL Archiving 

PostgreSQL gerÃ§ekleÅŸen transaction sonucu deÄŸiÅŸen data blocklarÄ±nÄ± bilgisini 16mb lÄ±k wal dosyalarÄ±na yazarak ilerliyor. Bir checkpoint iÅŸlemi gerÃ§ekleÅŸtiÄŸi durumda checkpoint iÅŸleminden Ã¶nceki wal dosyalarÄ±nÄ± temizliyor.

filesystem backup aldÄ±ÄŸÄ±m bir yedeÄŸin alÄ±ndÄ±ÄŸÄ± zamandan itibaren bu wal dosyalarÄ±nÄ± silinmeden Ã¶nce baÅŸka bir yere taÅŸÄ±yabilirsem. Bu backup Ã¼zerine bu arÅŸivlenen wal dosyalarÄ± birleÅŸtirerek redo-log  iÅŸleminin baÅŸlamasÄ±nÄ± saÄŸlayabilirim.

select name,setting,short_desc from pg_Settings where name like 'archive%';


Bu Ã¶zelliÄŸi kullanabilmek iÃ§in, 
archive_mode = on
archive_command = tetiklenmesi istediÄŸim komutu belirtmem gerekiyor. 

archive_command = 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'  

Ã¶rnek komutu inceler isek.

test ! -f wal dosyasÄ± kopyalanan yere daha Ã¶nce taÅŸÄ±nmÄ±ÅŸmÄ± kontrol ediyor.
cp kopyalama iÅŸini yapan komutumuz.

%p  wal dizinin komutu
ve %f wal dosyasÄ±nÄ±n ismi bu deÄŸiÅŸkenler postgresql tarafÄ±ndan saÄŸlanan deÄŸiÅŸkenler.


Ã‡ALIÅMA

Postgres kullanÄ±cÄ±sÄ±nda

1- wal dosyalarÄ±nÄ±n kopyasÄ±nÄ± tutacaÄŸÄ±mÄ±z bir dizin oluÅŸturulur.

 mkdir -p /data/backups/archive_wals

2- psql ile postgresql sunucusuna baÄŸlanÄ±lÄ±r. Archive iÅŸlemi iÃ§in ayarlamalar yapÄ±lÄ±r.

alter system set archive_mode to on;

alter system set archive_command to 'test ! -f /data/backups/archive_wals/%f && cp %p /data/backups/archive_wals/%f'  ;


test ! -f /data/backups/archive_wals/000000010000000000000082 && cp pg_wal/000000010000000000000082 /data/backups/archive_wals/000000010000000000000082

archive_command = 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'  # Unix
-- olmasÄ± gereken
test ! -f /mnt/server/archivedir/00000001000000A900000065 && cp pg_wal/00000001000000A900000065 /mnt/server/archivedir/00000001000000A900000065


-- archive_command saÄŸlÄ±klÄ± Ã§alÄ±ÅŸmÄ±yor bir sorun diyelim.
archive_command = '/bin/bash' ÅŸeklinde tanÄ±mlanabilir.


alter system set archive_command to '123';

select pg_reload_conf();

archiver sÃ¼recini loglarda yada pg_Stat_arciver takip edilmesi.

-- https://www.postgresql.org/docs/16/monitoring-stats.html#PG-STAT-ARCHIVER-VIEW

archived_count bigint
Number of WAL files that have been successfully archived

Ne kadar dosya baÅŸarÄ±lÄ± arÅŸivlendi

last_archived_wal text
Name of the WAL file most recently successfully archived

en son arÅŸiv iÅŸlemi baÅŸarÄ±lÄ± olan wal dosyasÄ±nÄ±n ismi

last_archived_time timestamp with time zone
Time of the most recent successful archive operation

âš ï¸ en son arÅŸiv iÅŸlemi baÅŸarÄ±lÄ± olma zamanÄ±

failed_count bigint
Number of failed attempts for archiving WAL files

KaÃ§ kez hata ile karÅŸÄ±laÅŸÄ±ldÄ±ÄŸÄ±

last_failed_wal text
Name of the WAL file of the most recent failed archival operation

ArÅŸivlenmesinde ata alÄ±nan dosya

âš ï¸ last_failed_time timestamp with time zone
Time of the most recent failed archival operation

En son arÅŸiv iÅŸlemi baÅŸarÄ±sÄ±z olma zamanÄ±


â˜¢ï¸ If the file system containing pg_wal/ fills up, PostgreSQL will do a PANIC shutdown. No committed transactions will be lost, but the database will remain offline until you free some space.

pg_wal dizini dolduÄŸu durumda PostgreSQL kapanÄ±r. TransactionlarÄ±n logunu tutacak yer kalmadÄ±ÄŸÄ± iÃ§in.


26.3.2. Making a Base Backup
https://www.postgresql.org/docs/16/continuous-archiving.html#BACKUP-BASE-BACKUP


The easiest way to perform a base backup is to use the pg_basebackup tool. It can create a base backup either as regular files or as a tar archive. 

Postgresql client application iÃ§inde pg_basebackup aracÄ± bulunmaktadÄ±r. Bu arac ile postgresql dizinin kopyasÄ±nÄ± Postgresql Ã§alÄ±ÅŸÄ±rken kopyasÄ±nÄ± alabiliyoruz.


Bu pg_basebackup aracÄ±nÄ±da Ã¶ÄŸrendiÄŸimiz gÃ¶re, Ãœretim ortamlarÄ±mÄ±z iÃ§in kesinti olmadan sÃ¼rekii yedek alacaÄŸÄ±mÄ±z yÃ¶ntemi oluÅŸturacak bilgiye ve araÃ§lara sahip olduk.

SÃ¼rekli yedekleme saÄŸlayacak backup yapÄ±sÄ±nÄ± kurgulamak iÃ§in.

1-PostgreSQL dizinin full kopyasÄ± lazÄ±m (pg_basebackup)
2-pg_wal dizininde dosyalarÄ±nda sÃ¼rekli olarak yedekleyecek ÅŸekilde PostgreSQL serverÄ±n ayarlanmasÄ± (archiver process)

Ã‡alÄ±ÅŸma pg_basebackup


Backup alÄ±nacak data dizin oluÅŸturulmamÄ±ÅŸ ise
mkdir -p /data/backups/basebackups/   

su - postgres
/usr/lib/postgresql/17/bin/pg_basebackup -h 10.10.11.131 -p 5432 -D   /pgdata/backups/basebackups/basebackup_20241017


26.3.4. Recovering Using a Continuous Archive Backup
https://www.postgresql.org/docs/16/continuous-archiving.html#BACKUP-PITR-RECOVERY

En kÃ¶tÃ¼ senaryo gerÃ§ekleÅŸti PostgreSQL serverÄ±nÄ±/sunucusunun kaybettik.
Yeni bir sunucuya PostgreSQL serverÄ±mÄ±zÄ± ayaÄŸa kaldÄ±rmamÄ±z gerekiyor bu durumda.


cp -r basebackup_20250520/ /data/yedekten_donus/   


touch standby.signal ,recovery modda baÅŸlatÄ±yor.

14:00 

pgdump , pgdumpall
archive_mode , archive_command , ,wal archiving
pg_basebackup , fiziksel yedek almak istediÄŸimiz, data_dizinin kopyasÄ±nÄ± almak istediÄŸimizde.



26.3.5. Timelines

Wal dosyalarÄ± yazÄ±lÄ±rken bir zaman Ã§izelgesine sahiptirler. Bu zaman Ã§izelgesinden yararlanÄ±larak . wal dosyalarÄ± tekrardan oynatÄ±lÄ±rken belirtilen bir zamana kadar oynatÄ±lmasÄ± saÄŸlanabilir. 
TÃ¼m wal dosyalarÄ±nÄ±n oynatÄ±lmasÄ±nÄ±n aksine.


Bu sayede veritabanÄ±nda deÄŸiÅŸikliÄŸe uÄŸradÄ±ÄŸÄ± zamandan Ã¶ncesine dÃ¶nÃ¼ÅŸ saÄŸlanabilir.


restore_command = 'cp /pgdata/backups/archive_wals/%f %p'  
recovery_target_time =â€™2023-01-17 10:36:11â€™


CALÄ°SMA pitr


-- master 
create database pazartesi;

-- backup
pg_basebackup -D   /data/backups/basebackups/basebackup_pazartesi

11:22 0000000100000000000000B4

-- master 

psql -c "create database sali;"

psql -c "select pg_Switch_wal()"


11:23 0000000100000000000000B5

-- master 
psql -c "create database carsamba;"
psql -c "select pg_Switch_wal()"

11:24 0000000100000000000000B6

-- master
psql -c "create database cuma;"

11:25 0000000100000000000000B7



Ã¶nce fiziksel kopyam lazÄ±m. pg_basebackup 

cp -R basebackup_pazartesi/  /data/pitr

aÃ§Ä±k archive parametleri kapatÄ±ldÄ±.


-- arÅŸivlediÄŸim wal dosyalarÄ±nÄ± yedekten_donus Ã¼zerine alacaktÄ±r. 
restore_command = 'cp /data/backups/archive_wals/%f %p'  ;


-- ÅŸimdiye kadar arÅŸivlenen ve gelmeye devam eden wal dosyalarÄ±nÄ± oynatacaktÄ±r.

recovery_target_time ='2025-05-20 11:24:00'

touch standby.signal

11:24 0000000100000000000000B6

ileriye doÄŸru gidilmede sÄ±kÄ±ntÄ± yok. geri dÃ¶nmek istendiÄŸinde. 

tekradan fiziksel kopya + rrestore_command + recovery_target_time  ayarÄ± gerekecektir.

-- wal dosyalarÄ±nÄ± icersi incelemek istenirse.

/usr/lib/postgresql/17/bin/pg_waldump 000000010000000000000071

/*------------------------------------------------------------
ğŸŒ https://www.postgresql.org/docs/current/high-availability.html
â­•ï¸ Chapter 26. High Availability, Load Balancing, and Replication
-- YÃ¼ksek eriÅŸlebilirlik, YÃ¼k dengeleme ve Replikasyon
------------------------------------------------------------

ğŸ”¸ High Availability , YÃ¼ksek EriÅŸlebilirlik,
Birincil sunucu (Master) arÄ±zalanmasÄ± durumunda ikinci bir sunucunun hÄ±zlÄ±ca gÃ¶revi devralmasÄ± YÃ¼ksek EriÅŸlebilirlik .

ğŸ”¸ Load Balancing , YÃ¼k dengeleme
AynÄ± verinin birden fazla sunucu tarafÄ±ndan sunulmasÄ± (yÃ¼k dengeleme).


MASTER , PRIMARY, Birincil,  Read / Write iÅŸlemleri kabul eden sunucu, 
STANDBY, SECONDARY , Birincil masterdaki sunucudaki deÄŸiÅŸiklikleri izleyen sunucular.
Hot standby , recovery modda, baÄŸlantÄ± kabul eden ve okuma iÅŸlemlerine izin veren standby .varsayÄ±lan
Warm standby, recovery modda bekleyen standby. BaÄŸlantÄ± kabul etmez.

PostgreSQL replikasyon sÃ¼reÃ§lerinin temeli, WAL (Write-Ahead Log) dosyalarÄ±nÄ±n taÅŸÄ±nmasÄ±na dayanÄ±r.
Wal dosyasÄ± yok ise replikasyonda yok diyebiliriz.


WAL DosyasÄ± Transferi Ä°ki yÃ¶ntemle gerÃ§ekleÅŸiyor;

ğŸ”¶ 1. File-Based Log Shipping (Dosya TabanlÄ±) (async)
ğŸ”¸  Directly moving WAL records from one database server to another is typically described as LOG SHIPPING.
ğŸ”¸	WAL kayÄ±tlarÄ±nÄ±n bir veritabanÄ± sunucusundan diÄŸerine doÄŸrudan taÅŸÄ±nmasÄ± iÅŸlemi, LOG SHIPPING olarak tanÄ±mlanÄ±r.
ğŸ”¸	WAL segmentleri (varsayÄ±lan olarak 16MB) tamamlandÄ±kÃ§a karÅŸÄ± sunucuya aktarÄ±lÄ±r. Ana sunucu aniden Ã§Ã¶kme yaÅŸanÄ±r ise gÃ¶nderilmemiÅŸ WAL kayÄ±tlarÄ±n kaybÄ± olabilir.
ğŸ”¸  DoÄŸasÄ± gereÄŸi Async dir.
ğŸ”¸  Archiver process (arÅŸivleme) sÃ¼reci Ã¼zerinden gerÃ§ekleÅŸtirilir.
ğŸ”¸  Yedekleme (Backup) ve Felaket Kurtarma (Disaster Recovery) senaryolarÄ±nda tercih edilir.
 

ğŸ”¶ 2. Record-Based Log Shipping (Streaming Replication) (sync - async)

ğŸ”¸  Record-based log shipping is more granular and streams WAL changes incrementally over a network connection.
ğŸ”¸  WAL deÄŸiÅŸikliklerini anlÄ±k (streaming) gÃ¶nderir.
ğŸ”¸	Streaming replication kullanÄ±larak gerÃ§ekleÅŸtirilir.
ğŸ”¸  Sync ve Async wal transferi saÄŸlanabilir.Veri kaybÄ± oluÅŸmasÄ± engellenebilir.
ğŸ”¸  Standby Sunucu ve YÃ¼ksek EriÅŸilebilirlik (High Availability) Ã§Ã¶zÃ¼mlerinde kullanÄ±lÄ±r.

Postgresql kullanabileceÄŸimiz 3 farklÄ± replikasyon yÃ¶ntemi bulunmakta;

1ï¸âƒ£ Log shipping  standby	      
, master (archive_command) , restore_command (standby )  , archive_cleanup_command ()
- standby,  read only  
- standby.signal 
- Backup Ã§Ã¶zÃ¼mÃ¼ dÃ¼ÅŸÃ¼nÃ¼lmesi daha iyi olur.
- database_cluster

2ï¸âƒ£ Streaming replication  , streaming protokol, master (wal_sender) , standby(wal_reciver) 
- standby , read only  
- standby.signal
- Standby Ã‡Ã¶zÃ¼mÃ¼
- database_cluster

3ï¸âƒ£ logical replication  , streaming protokol, publisher (producer) , subscriber (consumer) 
-  standby , read/write  
-  Change Data Capture (CDC)
-  DatanÄ±n bir bÃ¶lÃ¼mÃ¼nÃ¼ replikasyonunda


15:15 - 16:00 (45dk)

27.2.4. Setting Up a Standby Server 

iki farklÄ± postgresql servere Ã§alÄ±ÅŸacak sunucu ayarlanÄ±r.

wal dosyalarÄ±nÄ± taÅŸÄ±nmasÄ± saÄŸlamak ÅŸifresiz ssh ayarlanÄ±r.


master / standby 

su - postgres 

ssh-keygen -t rsa

ssh-copy-id -i ~/.ssh/id_rsa.pub postgres@standby_ip



wal dosyalarÄ± transferinin ayarlanmÄ±as log- shipping.

-- MASTER Ã¼zerinde

archive_mode = on
archive_command = 'test ! -f postgres@STANDBY_IP:/pgdata/backup_wals/%f && rsync -a %p 
postgres@STANDBY_IP:/pgdata/backup_wals/%f'

archive_cleanup_command = 'pg_archivecleanup /data/backups/archive_wals/%f %r'


/data/backups/archive_wals

-- standby Ã¼zerinde fiziksel kopyla alÄ±nmasÄ±. pg_basebackup

/usr/lib/postgresql/17/bin/pg_basebackup -h 10.10.11.141 -p 5432 -D /data/simple_data/

select pg_is_in_recovery(); true ,   standby.singal vardÄ±r demek dizinde.

-- standby -> promote komuut yÃ¼rÃ¼tÃ¼rsen okuma yazma kabul ediyor.

pg_Ctl promote

psql -> select pg_promote();

select pg_is_in_recovery(); --> false


âš ï¸ archive_timeout parametresi eÄŸer log shipping yapÄ±lÄ±yor ise, tanÄ±mlanmasÄ± Ã¶nerilir.
default durumu 0 yani aktif deÄŸildir.

ğŸ’» Ã–rneÄŸin gece hiÃ§ transaction gerÃ§ekleÅŸmiyor ise son wal dosyasÄ± gece boyu dolmayacaÄŸÄ± iÃ§in son wal dosyasÄ± sabah iÅŸlemlerin baÅŸladÄ±ÄŸÄ± saati bekleyecektir.

archive_timeout 600 olarak ayarlanÄ±r ise, her 5dk bir switch_wal iÅŸlem gerÃ§ekleÅŸecektir, yarÄ±m kalan wal dosyasÄ± Ã¼zerine yeni wal dosyasÄ± oluÅŸacaÄŸÄ± iÃ§in tetiklenmesi saÄŸlanÄ±r.

Eski wal dosyasÄ± yarÄ±mda olsa archive_command yarÄ±m wal dosyasÄ±ndada tetiklenecektir.


logical replication temelli Ã§alÄ±ÅŸan mÃ¼lti master Ã§Ã¶zÃ¼mleri
pg_edge, edb pgd ,  pg_logical 


































































































































































